name: Expo Preview Server

on:
  workflow_dispatch:  # Manual trigger

jobs:
  expo-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Keep alive for 1 hour

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Install ngrok
        run: npm install -g @expo/ngrok@^4.1.0

      - name: Start Expo with tunnel
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx expo start --tunnel 2>&1 | tee expo-output.log &
          EXPO_PID=$!

          echo "Waiting for tunnel URL..."
          for i in {1..90}; do
            # Try multiple URL patterns
            TUNNEL_URL=$(grep -oE 'exp://[^[:space:]]+' expo-output.log 2>/dev/null | head -1)
            if [ -z "$TUNNEL_URL" ]; then
              TUNNEL_URL=$(grep -oE 'https://[a-z0-9-]+\.ngrok[^[:space:]]*' expo-output.log 2>/dev/null | head -1)
            fi
            if [ -z "$TUNNEL_URL" ]; then
              TUNNEL_URL=$(grep -oE 'exp\+[^[:space:]]+' expo-output.log 2>/dev/null | head -1)
            fi

            if [ -n "$TUNNEL_URL" ]; then
              echo ""
              echo "========================================="
              echo "EXPO GO URL:"
              echo "$TUNNEL_URL"
              echo "========================================="

              # Write to GitHub Actions Summary
              echo "## ðŸ“± Expo Go Preview" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Open in Expo Go:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "$TUNNEL_URL" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "_Server will stay alive for ~60 minutes_" >> $GITHUB_STEP_SUMMARY

              break
            fi
            echo "Waiting... ($i/90)"
            sleep 2
          done

          # Show log contents for debugging
          echo ""
          echo "=== Current expo-output.log ==="
          cat expo-output.log
          echo "==============================="

          if [ -z "$TUNNEL_URL" ]; then
            echo "WARNING: Could not extract tunnel URL automatically"
            echo "Check the log above for the URL"
          fi

          echo ""
          echo "Server is running. Check logs or Summary tab for the URL."
          echo ""

          # Keep the job alive
          tail -f expo-output.log
