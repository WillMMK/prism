name: Expo Preview Server

on:
  workflow_dispatch:

jobs:
  expo-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Install ngrok
        run: npm install -g @expo/ngrok@^4.1.0

      - name: Start Expo and get URL
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # Start expo in background
          npx expo start --tunnel 2>&1 | tee expo.log &
          SERVER_PID=$!

          echo "Waiting for server to start..."
          sleep 20

          # Try to get URL using expo export command or parse from ngrok
          echo "Checking for tunnel URL..."

          # Method 1: Check ngrok API directly
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | grep -oE 'https://[^"]+\.ngrok[^"]*' | head -1)

          if [ -n "$NGROK_URL" ]; then
            EXPO_URL="exp://${NGROK_URL#https://}"
            echo ""
            echo "========================================="
            echo "EXPO GO URL:"
            echo "$EXPO_URL"
            echo "========================================="
            echo ""

            echo "## ðŸ“± Expo Go Preview" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Paste this in Expo Go:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$EXPO_URL" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Or use ngrok URL:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$NGROK_URL" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Could not get URL from ngrok API"
            echo "=== Expo Log ==="
            cat expo.log
            echo "================"
          fi

          echo ""
          echo "Server running for 60 minutes..."

          # Keep alive
          wait $SERVER_PID
