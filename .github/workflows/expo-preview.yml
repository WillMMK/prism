name: Expo Preview Server

on:
  workflow_dispatch:  # Manual trigger

jobs:
  expo-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Keep alive for 1 hour

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install ngrok
        run: npm install -g @expo/ngrok@^4.1.0

      - name: Start Expo with tunnel
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx expo start --tunnel 2>&1 | tee expo-output.log &
          EXPO_PID=$!

          echo "Waiting for tunnel URL..."
          for i in {1..90}; do
            TUNNEL_URL=$(grep -o 'exp+[^[:space:]]*' expo-output.log 2>/dev/null | head -1)
            if [ -n "$TUNNEL_URL" ]; then
              echo ""
              echo "========================================="
              echo "EXPO GO URL:"
              echo "$TUNNEL_URL"
              echo "========================================="

              # Write to GitHub Actions Summary (visible on workflow page)
              echo "## ðŸ“± Expo Go Preview" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Scan this URL in Expo Go:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "$TUNNEL_URL" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Or open directly:** [Open in Expo Go](https://expo.dev/go?url=$TUNNEL_URL)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "_Server will stay alive for ~60 minutes_" >> $GITHUB_STEP_SUMMARY

              break
            fi
            echo "Waiting... ($i/90)"
            sleep 2
          done

          if [ -z "$TUNNEL_URL" ]; then
            echo "ERROR: Could not get tunnel URL"
            cat expo-output.log
            exit 1
          fi

          echo ""
          echo "Server is running. Check the Summary tab for the URL."
          echo "This workflow will stay alive for ~60 minutes."
          echo ""

          # Keep the job alive - show live logs
          tail -f expo-output.log
