name: Expo Preview Server

on:
  workflow_dispatch:  # Manual trigger

jobs:
  expo-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Keep alive for 1 hour

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install ngrok
        run: npm install -g @expo/ngrok@^4.1.0

      - name: Start Expo with tunnel
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx expo start --tunnel 2>&1 | tee expo-output.log &
          EXPO_PID=$!

          echo "Waiting for tunnel URL..."
          for i in {1..60}; do
            if grep -q "exp+" expo-output.log 2>/dev/null; then
              echo ""
              echo "========================================="
              echo "EXPO GO URL (scan with Expo Go app):"
              echo "========================================="
              grep -o 'exp+[^[:space:]]*' expo-output.log | head -1
              echo "========================================="
              echo ""
              break
            fi
            sleep 2
          done

          echo "Server is running. Check the URL above."
          echo "This workflow will stay alive for ~60 minutes."
          echo ""

          # Keep the job alive
          tail -f expo-output.log
