name: Expo Preview Server

on:
  workflow_dispatch:  # Manual trigger

jobs:
  expo-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Install ngrok
        run: npm install -g @expo/ngrok@^4.1.0

      - name: Start Expo with tunnel
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          CI: ""
        run: |
          # Start expo and capture output, stripping ANSI codes
          npx expo start --tunnel --non-interactive 2>&1 | sed 's/\x1b\[[0-9;]*m//g' | tee expo-output.log &

          echo "Waiting for tunnel..."
          sleep 30

          echo ""
          echo "=== EXPO OUTPUT ==="
          cat expo-output.log
          echo "==================="
          echo ""

          # Extract any URL-like patterns
          echo "=== FOUND URLs ==="
          grep -oE '(exp|https?)://[^[:space:]"<>]+' expo-output.log || echo "No URLs found yet"
          echo "==================="

          # Write to summary
          echo "## ðŸ“± Expo Dev Server Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat expo-output.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo ""
          echo "Server running. Look for exp:// or ngrok URL above."
          echo "Keeping alive for 60 minutes..."

          # Keep alive and show new output
          tail -f expo-output.log
